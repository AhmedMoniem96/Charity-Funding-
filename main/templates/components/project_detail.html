{% extends "parent.html" %}
{% load static %}
{% block style %}
<link href="{% static 'users/css/rating.css' %}" rel="stylesheet">

{% endblock %}
{% block content %}
<div class="container py-5">
    <h1 class="display-4">{{ project.title }}</h1>

    {% if project.projectpictures_set.all %}
    <div class="mb-4">
        <div class="row">
            {% for picture in project.projectpictures_set.all %}
            <div class="col-md-4">
                <img src="{{ picture.image.url }}" class="img-fluid mb-2" alt="{{ project.title }}"
                    style="max-height: 300px; object-fit: cover;">
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title"><strong>Description:</strong></h5>
            <p class="card-text">{{ project.details }}</p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <p><strong>Category:</strong> {{ project.category.name }}</p>
            <p><strong>Created by:</strong> {{ project.creator.fname }} {{ project.creator.lname }}</p>
        </div>
        <div class="col-md-6">
            <p><strong>Tags:</strong>
                {% for tag in project.tags.all %}
                <span class="badge bg-secondary">{{ tag.name }}</span>
                {% empty %}
                <span class="text-muted">No tags</span>
                {% endfor %}
            </p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <p><strong>Raised:</strong> ${{ project.current_amount }} / ${{ project.target }}</p>
        </div>
        <div class="col-md-6">
            <p><strong>Start:</strong> {{ project.start_time|date:"M d, Y" }}</p>
            <p><strong>End:</strong> {{ project.end_time|date:"M d, Y" }}</p>
        </div>
    </div>

    {% if project.can_be_cancelled %}
    <p><span class="badge bg-warning">Can be cancelled</span></p>
    {% endif %}

    <!-- Rating Section -->
    
<div class="">
    <h2>Rate this product</h2>
    <div class="star-rating">
        <input type="radio" onclick="addRate({{project.id}},value)" name="rating" value="1"><i></i>
        <input type="radio" onclick="addRate({{project.id}},value)" name="rating" value="2"><i></i>
        <input type="radio" onclick="addRate({{project.id}},value)" name="rating" value="3"><i></i>
        <input type="radio" onclick="addRate({{project.id}},value)" name="rating" value="4"><i></i>
        <input type="radio" onclick="addRate({{project.id}},value)" name="rating" value="5"><i></i>
    </div>
    <div class="mt-3">
        <span id="rating-value" class="h4">0</span> out of 5 stars
    </div>
</div>
        <hr>

        <!-- Display Average Rating -->
        <div id="rates-all" class="mt-4">
            
        </div>
    </div>
    <hr>
    <section id="comments-all" class="container mt-5">
        <!-- COMMENT FORM -->
        <div class="d-flex align-items-start mb-4">
            <img src="${data[0][0]}" alt="avatar" class="rounded-circle me-3" width="48" height="48">
            <div class="flex-grow-1">
                <input type="text" id="commentv" class="form-control rounded-pill" placeholder="Write a comment...">
                <div class="mt-2">
                    <button onclick="addComment(${id})" class="btn btn-sm btn-outline-primary">Post</button>
                </div>
            </div>
        </div>
    
        <!-- SINGLE COMMENT -->
        <div class="d-flex align-items-start mb-4">
            <img src="${comment.user_photo}" alt="avatar" class="rounded-circle me-3" width="48" height="48">
            <div class="flex-grow-1 bg-light p-3 rounded shadow-sm">
                <div class="d-flex justify-content-between">
                    <strong>${comment.fname || "Admin"}</strong>
                    <small class="text-muted">${comment.created_at.slice(0, 10)}</small>
                </div>
                <p class="mb-1">${comment.content}</p>
                <div class="d-flex gap-2">
                    <button onclick="toggleReplies(${comment.id})" class="btn btn-sm btn-link p-0">View Replies</button>
                    <button onclick="togglereplyinput(${comment.id})" class="btn btn-sm btn-link p-0">Reply</button>
                </div>
            </div>
        </div>
    
        <!-- REPLY -->
        <div class="d-flex align-items-start mb-3 ms-5">
            <img src="${reply.user_photo}" alt="avatar" class="rounded-circle me-3" width="40" height="40">
            <div class="flex-grow-1 bg-white border p-2 rounded">
                <div class="d-flex justify-content-between">
                    <strong>${reply.fname || "Admin"}</strong>
                    <small class="text-muted">${reply.created_at.slice(0, 10)}</small>
                </div>
                <p class="mb-1">${reply.content}</p>
            </div>
        </div>
    
        <!-- REPLY INPUT -->
        <div class="d-flex align-items-start ms-5 mb-4">
            <img src="${data[0][0]}" alt="avatar" class="rounded-circle me-3" width="40" height="40">
            <div class="flex-grow-1">
                <input type="text" id="reply${comment.id}" class="form-control rounded-pill" placeholder="Write a reply...">
                <div class="mt-2">
                    <button onclick="addReply(${comment.id})" class="btn btn-sm btn-outline-primary">Post</button>
                </div>
            </div>
        </div>
    </section>
    {% endblock %}
    {% block js %}
    <script src="{% static 'users/js/comment-reply-rate.js'%}"></script>
    <script>
        getComments({{ project.id }});
        getRates({{ project.id }});
        const starRating = document.querySelector('.star-rating');
        const ratingValue = document.getElementById('rating-value');

        starRating.addEventListener('change', function(e) {
            ratingValue.textContent = e.target.value;
        });
    </script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mdbootstrap@5.2.0/js/mdb.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@5.2.0/js/mdb.min.js"></script>

    {% endblock %}